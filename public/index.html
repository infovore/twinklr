<!doctype html>
<html>
  <head>
    <title>Twinklr</title>
    <link rel="stylesheet" type="text/css" href="css/musicbox.css">
    <meta charset="utf-8" /> 
  </head>
  <body>

    <div id="container">
      <svg xmlns='http://www.w3.org/2000/svg' id="stave"></svg>
      <div id='ui'>
        <ul class='buttons'>
          <li><a href='#' id='alter-sequence-length'>Sequence Length</a></li>
          <li><a href='#' id='scale-options'>Scale</a></li>
          <li><a href='#' id='midi-options'>MIDI</a></li>
          <li><a href='#' id='save-load'>Save/Load</a></li>
        </ul>
        <div id='ui-details'>
          <div class='inner'>
          </div>
        </div>
      </div>
    </div>

    <script id='template-alter-sequence-length' type="text/template">
      Adjust sequence length. <a href='#' class='hide-ui'>Done</a>
    </script>

    <script id='template-scale-options' type="text/template">
      <b>Scale options</b>
      Root note:
      <select id='scale-root' name='root'>
        <option value='c'>C</option>
        <option value='g'>G</option>
        <option value='d'>D</option>
        <option value='a'>A</option>
        <option value='e'>E</option>
        <option value='b'>B</option>
        <option value='f#'>F#</option>
        <option value='c#'>C#</option>
        <option value='g#'>A♭</option>
        <option value='d#'>E♭</option>
        <option value='a#'>B♭</option>
        <option value='f'>F</option>
      </select>
      Scale:
      <select id='scale-type' name='scale'>
        <option value='major'>Major</option>
        <option value='minor'>Minor</option>
        <option value='dorian'>Dorian</option>
        <option value='lydian'>Lydian</option>
        <option value='mixolydian'>Mixolydian</option>
        <option value='phrygian'>Phrygian</option>
        <option value='locrian'>Locrian</option>
        <option value='pentatonic'>Pentatonic</option>
        <option value='blues'>Blues</option>
      </select>

      <a href="#" class='hide-ui'>Done</a>
    </script>

    <script id="template-save-load" type="text/template">
      <b>Save</b>
      <a class='save-button' data-slot='1' href="#">1</a>
      <a class='save-button' data-slot='2' href="#">2</a>
      <a class='save-button' data-slot='3' href="#">3</a>
      <a class='save-button' data-slot='4' href="#">4</a>
      <a class='save-button' data-slot='5' href="#">5</a>
      <a class='save-button' data-slot='6' href="#">6</a>
      <a class='save-button' data-slot='7' href="#">7</a>
      <a class='save-button' data-slot='8' href="#">8</a>
      <b>Load</b>
      <a class='load-button' data-slot='1' href="#">1</a>
      <a class='load-button' data-slot='2' href="#">2</a>
      <a class='load-button' data-slot='3' href="#">3</a>
      <a class='load-button' data-slot='4' href="#">4</a>
      <a class='load-button' data-slot='5' href="#">5</a>
      <a class='load-button' data-slot='6' href="#">6</a>
      <a class='load-button' data-slot='7' href="#">7</a>
      <a class='load-button' data-slot='8' href="#">8</a>

      <a href="#" class='hide-ui'>Close</a>
    </script>


    <script type='text/javascript'>
      <!--window.$ = window.jQuery = require('./js/jquery.min.js');-->
      <!--window.buzz = require('./js/buzz.min.js');-->
    </script>
    <script type='text/javascript' src='./js/jquery.min.js'></script>
    <!--<script type='text/javascript' src='./js/jquery.svg.min.js'></script>-->
    <script type='text/javascript' src='./js/snap.svg-min.js'></script>
    <!--<script type='text/javascript' src='./js/jquery.svganim.min.js'></script>-->
    <script type='text/javascript' src='./js/buzz.min.js'></script>
    <script type='text/javascript' src='./js/jquery-mousewheel.min.js'></script>
    <script type='text/javascript' src='./js/underscore-min.js'></script>
    <script type='text/javascript' src='./js/backbone-min.js'></script>
    <script type='text/javascript' src='./js/buzz.min.js'></script>
    <script type='text/javascript' src='./js/dispatcher.js'></script>
    <script type='text/javascript' src='./js/soundbox.js'></script>
    <script type='text/javascript' src='./js/models/note.js'></script>
    <script type='text/javascript' src='./js/models/playhead.js'></script>
    <script type='text/javascript' src='./js/collections/tune.js'></script>
    <script type='text/javascript' src='./js/note_view_manager.js'></script>
    <script type='text/javascript' src='./js/views/stave.js'></script>
    <script type='text/javascript' src='./js/views/note_view.js'></script>
    <script type='text/javascript' src='./js/views/midi.js'></script>

    <script type='text/javascript'>
      $(document).ready(function() {
        window.tune = new app.Tune();
        window.stave = new app.Stave(tune);
        window.playhead = new app.Playhead(stave.snap,stave.width,stave.height,stave);
        
        if(navigator.requestMIDIAccess) {
          appMidi = new app.Midi();
        }

        $("#ui .buttons a").click(function() {
          var id = $(this).attr('id');
          app.editMode = id;

          dimNotes();

          $("#ui-details .inner").html($('#template-'+id).html());

          $("#scale-root").val(app.soundBox.scaleRoot);
          $("#scale-type").val(app.soundBox.scaleType);

          $("#ui-details").css('bottom', -100);
          $("#ui-details").show();

          $("#ui-details").animate({bottom: 0});

          return false;
        });
        $("#ui").on('click', '.hide-ui',function() {
          unDimNotes();
          app.editMode = null;
          $("#ui-details").animate({bottom: -100}, function() {
            $("#ui-details").hide();
            $("#ui-details .inner").html('');
          });

          app.dispatcher.trigger('tidyNotes');
          return false;
        });

        $("#ui").on('change', '#scale-root', function() {
          app.soundBox.updateScaleRoot($(this).val());
        });
        $("#ui").on('change', '#scale-type', function() {
          app.soundBox.updateScaleType($(this).val());
          app.noteViewManager.recolourNotes();
        });
        
        $("#ui").on('click', '.save-button', function() {
          var slot = $(this)[0].dataset.slot

          var data = {};
          data.notes = [];

          window.tune.each(function(note) {
            data.notes.push({x: note.get('x'),
                        y: note.get('y'),
                        index: note.get('index')});
          });

          data.scaleType = app.soundBox.scaleType;
          data.scaleRoot = app.soundBox.scaleRoot;
          data.staveWidth = window.stave.staveWidth;

          $.post('/save/'+slot, {data: data});

          $(".hide-ui").click();
          return false;
        });

        $("#ui").on('click', '.load-button', function() {
          var slot = $(this)[0].dataset.slot
            $.get('/load/'+slot, function(data) {
              var newTune = data.data;

              // delete all notes
              _.each(app.noteViewManager.noteViews, function(nv) {
                app.noteViewManager.deleteNoteView(nv.model.cid);
              });

              window.tune.reset();
              // set scaleRoot
              app.soundBox.scaleRoot = newTune.scaleRoot;
              // set scaleType
              app.soundBox.scaleType = newTune.scaleType;
              // set Width
              window.stave.updateWidthFromData(parseInt(newTune.staveWidth));
              // for each note

              console.log(newTune);
                // draw a note
              _.each(newTune.notes, function(note) {
                console.log("addingNote", note.x, note.y, note.index);
                window.tune.addNote(parseInt(note.x),parseInt(note.y),parseInt(note.index));
              });
              $(".hide-ui").click();
            });
          return false;
        });
      });

      function dimNotes() {
        $("circle").each(function(i) {
          Snap(this).animate({opacity: 0.3}, 150);
          Snap(this).addClass('dim');
        });
        app.dim = true;
      }

      function unDimNotes() {
        $("circle").each(function(i) {
          Snap(this).animate({opacity: 1.0}, 150);
          Snap(this).removeClass('dim');
        });
        app.dim = false;
      }
    </script>
  </body>
</html>
